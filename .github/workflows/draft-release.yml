name: Tag & Draft Release

on:
  push:
    branches:
      - "main"
    paths: 
      - 'src/**'
      - 'Pelican.sln'
      - 'Directory.Build.props'
      - 'CHANGELOG.md'

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # necesario para crear y subir tags

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # necesario para crear y subir tags

      - name: 🏷 Get tag from CHANGELOG.md
        id: changelog
        run: |
          TAG=$(grep -Pom 1 '^##\s+v\d+\.\d+\.\d+' CHANGELOG.md | sed 's/^##\s*//')
          echo "Tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          CONTENT=$(awk -v tag="## $TAG" '
            $0 == tag {flag=1; next}
            /^## / && flag {exit}
            flag {print}
          ' CHANGELOG.md)
          echo "$CONTENT" > release_notes.txt

      - name: 🔖 Create Git tag and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.changelog.outputs.tag }}
          git push origin ${{ steps.changelog.outputs.tag }}

      - name: 📝 Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.changelog.outputs.tag }}
          name: ${{ steps.changelog.outputs.tag }}
          body_path: release_notes.txt
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
